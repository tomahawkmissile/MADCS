#include <wiringPi.h>
#include <wiringPiI2C.h>
#define STB_IMAGE_IMPLEMENTATION
#include "../../../libs/stb/stb_image.h"

#include "../../../utils/logic/stringUtils/stringUtils.h"
#include "../../../utils/logic/swap/swap.h"
#include "../../../utils/symbols.h"

#include "oled.h"

static unsigned char adaLogo[1024] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x80, 0x80, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0xF8, 0xFC, 0xF8, 0xE0, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80,
0x80, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0xFF,
0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00,
0x80, 0xFF, 0xFF, 0x80, 0x80, 0x00, 0x80, 0x80, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x80, 0x80,
0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x8C, 0x8E, 0x84, 0x00, 0x00, 0x80, 0xF8,
0xF8, 0xF8, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0xC0, 0x80,
0x00, 0xE0, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFF, 0xC7, 0x01, 0x01,
0x01, 0x01, 0x83, 0xFF, 0xFF, 0x00, 0x00, 0x7C, 0xFE, 0xC7, 0x01, 0x01, 0x01, 0x01, 0x83, 0xFF,
0xFF, 0xFF, 0x00, 0x38, 0xFE, 0xC7, 0x83, 0x01, 0x01, 0x01, 0x83, 0xC7, 0xFF, 0xFF, 0x00, 0x00,
0x01, 0xFF, 0xFF, 0x01, 0x01, 0x00, 0xFF, 0xFF, 0x07, 0x01, 0x01, 0x01, 0x00, 0x00, 0x7F, 0xFF,
0x80, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x01, 0xFF,
0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x03, 0x0F, 0x3F, 0x7F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xC7, 0xC7, 0x8F,
0x8F, 0x9F, 0xBF, 0xFF, 0xFF, 0xC3, 0xC0, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xFC, 0xFC,
0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xF8, 0xF8, 0xF0, 0xF0, 0xE0, 0xC0, 0x00, 0x01, 0x03, 0x03, 0x03,
0x03, 0x03, 0x01, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01,
0x03, 0x01, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x03, 0x03, 0x00, 0x00,
0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x01, 0x03, 0x01, 0x00, 0x00, 0x00, 0x03,
0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0xF9, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x1F, 0x0F,
0x87, 0xC7, 0xF7, 0xFF, 0xFF, 0x1F, 0x1F, 0x3D, 0xFC, 0xF8, 0xF8, 0xF8, 0xF8, 0x7C, 0x7D, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x0F, 0x07, 0x00, 0x30, 0x30, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0xFE, 0xFE, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xC0, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0xC0, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x7F, 0x3F, 0x1F,
0x0F, 0x07, 0x1F, 0x7F, 0xFF, 0xFF, 0xF8, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xF8, 0xE0,
0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFE, 0x00, 0x00,
0x00, 0xFC, 0xFE, 0xFC, 0x0C, 0x06, 0x06, 0x0E, 0xFC, 0xF8, 0x00, 0x00, 0xF0, 0xF8, 0x1C, 0x0E,
0x06, 0x06, 0x06, 0x0C, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xFE, 0xFE, 0x00, 0x00, 0x00, 0x00, 0xFC,
0xFE, 0xFC, 0x00, 0x18, 0x3C, 0x7E, 0x66, 0xE6, 0xCE, 0x84, 0x00, 0x00, 0x06, 0xFF, 0xFF, 0x06,
0x06, 0xFC, 0xFE, 0xFC, 0x0C, 0x06, 0x06, 0x06, 0x00, 0x00, 0xFE, 0xFE, 0x00, 0x00, 0xC0, 0xF8,
0xFC, 0x4E, 0x46, 0x46, 0x46, 0x4E, 0x7C, 0x78, 0x40, 0x18, 0x3C, 0x76, 0xE6, 0xCE, 0xCC, 0x80,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x1F, 0x1F, 0x3F, 0x3F, 0x3F, 0x3F, 0x1F, 0x0F, 0x03,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00, 0x00,
0x00, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00, 0x00, 0x03, 0x07, 0x0E, 0x0C,
0x18, 0x18, 0x0C, 0x06, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x01, 0x0F, 0x0E, 0x0C, 0x18, 0x0C, 0x0F,
0x07, 0x01, 0x00, 0x04, 0x0E, 0x0C, 0x18, 0x0C, 0x0F, 0x07, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00,
0x00, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x07,
0x07, 0x0C, 0x0C, 0x18, 0x1C, 0x0C, 0x06, 0x06, 0x00, 0x04, 0x0E, 0x0C, 0x18, 0x0C, 0x0F, 0x07,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
static unsigned char buffer[1024];

int oled_fd;
const unsigned char DATA_REGISTER = 0x40;
const unsigned char COMMAND_REGISTER = 0x00;

typedef struct loadstr loadstr;
struct loadstr {
  int width;
  int height;
  unsigned char* data;
};
struct loadstr oled_loadman(const char* file) {
	int width,height,bpp;
	unsigned char* bdat=stbi_load(file,&width,&height,&bpp,STBI_rgb_alpha);
	unsigned char* odat=(unsigned char*)malloc(width*(height/8));
	for(int i=0;i<width;++i) {
		for(int j=0;j<(height/8);++j) {
			unsigned char bitsie=0;
			for(int k=0;k<8;++k) {
				bitsie|=(bdat[((i*bpp)+((j*8)*width*bpp)+(k*width)*bpp)]<<k)&(1<<k);
			}
 			odat[i+(width*j)]=bitsie;
		}
	}
	return (loadstr){ .width=width,.height=height,.data=odat };
}
static void sendChar(unsigned char data) {
	data &= 0xFF;
	wiringPiI2CWrite(oled_fd,data);
}
static void sendCharReg(unsigned char data, unsigned char reg) {
	data &= 0xFF;
	wiringPiI2CWriteReg8(oled_fd,reg,data);
}
static void sendShort(unsigned int data) {
	data &= 0xFFFF;
	wiringPiI2CWrite(oled_fd,data);
}
static void sendShortReg(unsigned int data, unsigned char reg) {
	data &= 0xFFFF;
	wiringPiI2CWriteReg8(oled_fd,reg,data);
}
static void sendDisplayInitCommands() {
	sendCharReg(0x21,COMMAND_REGISTER);
	sendCharReg(0x00,COMMAND_REGISTER);
	sendCharReg(0x7F,COMMAND_REGISTER);
	sendCharReg(0x22,COMMAND_REGISTER);
	sendCharReg(0x00,COMMAND_REGISTER);
    sendCharReg(0x07,COMMAND_REGISTER);
}
void oled_clearBuffer() {
	for(int i=0;i<1024;i++) {
		buffer[i] = 0x00;
	}
}
void oled_fillBuffer(unsigned char fill) {
	for(int i=0;i<1024;i++) {
		buffer[i] = fill;
	}
}
void oled_displayBuffer() {
	sendDisplayInitCommands();
	for(int i=0;i<1024;i++) {
		sendCharReg(buffer[i],DATA_REGISTER);
	}
}
void oled_writePixel(int x,int y,int state) {
	switch (state) {
		case 1:
			buffer[x+(y/8)*128]|=(1 << (y&7));
			break;
		case 0:
			buffer[x+(y/8)*128]&=~(1 << (y&7));
			break;
		case 2:
			buffer[x+(y/8)*128]^=(1 << (y&7));
			break;
	}
}
void oled_writeImage(const char* path,int x,int y) {
	sendDisplayInitCommands();
	loadstr s = oled_loadman(path);
	for(int i=0;i<s.width*(s.height/8);i++) {
		buffer[(x+(y/8)*128)+i]|=(s.data[i]<<(y&7));
		if(y%8!=0) {
			buffer[(x+(y/8)*128)+i+128]|=(s.data[i]>>(8-(y&7)));
		}
	}
}
void oled_writeChar(char c, int x, int y) {
  char alphabet[] = " !\"#$%&\'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}";
  char* alphaArray = {strtok(strdup(alphabet), "")};

  int width = 5;
  int indexX = 0;
  int indexY = 0;

  for (unsigned int i = 0; i < strlen(alphabet); i++) {
    if (c == alphaArray[i]) {
      unsigned char pixel_buffer[5] = {symbols_8x5[i * 5], symbols_8x5[(i * 5) + 1], symbols_8x5[(i * 5) + 2], symbols_8x5[(i * 5) + 3], symbols_8x5[(i * 5) + 4]};
      for (int j = 0; j < width; j++) {
        for (unsigned char bit = 0x01; bit; bit <<= 1) {
          int xN = x + indexX;
          int yN = y + indexY;
          if (bit & pixel_buffer[j]) {
            oled_writePixel(xN, yN, 1);
          } else {
            oled_writePixel(xN, yN, 0);
          }
          indexY++;
          if (indexY > 7) {
            indexX++;
            indexY = 0;
          }
        }
      }
    }
  }
}
void oled_writeString(const char* data, int x, int y, int maxl, int* h) {

  char* array = {strtok(strdup(data), "")};

  int indexX = 0;
  int indexY = 0;

  for (unsigned int i = 0; i < strlen(data); i++) {
    oled_writeChar(array[i], x + indexX, y - indexY);
    indexX += 6;
    if (indexX > maxl) {
      indexX = 0;
      indexY += 8;
      *h += 8;
    }
  }
}
/*
void writeString(const char* data,int x,int y) {
	if(x>127||y>63) {
		return;
	}
	const char* basePath = "font/";
	int length = strlen(data);
	char* tokens = strtok(const_cast<char*>(data),"");
	int y_old;
	for(int i=0;i<length;i++) {
		if(x>125) {
			x=0;
			y+=8;
		}
		if(y>63) {
			
		}
		if(tokens[i]=='/'&&tokens[i+1]=='*') {
			x=0;
			y+=8;
			tokens[i]='\0';
			tokens[i+1]='\0';
		}
		if(tokens[i]=='/') {
			const char* finA=strUtil.str_concat(basePath,"slash.png");
			writeImage(finA,x,y);
		} else if(tokens[i]==' ') {
			const char* finA=strUtil.str_concat(basePath,"space.png");
			writeImage(finA,x,y);
		} else if(tokens[i]=='\0') {
			continue;
		} else {
			const char* finA=strUtil.str_concat(basePath,&tokens[i]);
			const char* finB=strUtil.str_concat(finA,".png");
			writeImage(finB,x,y);
		}
		x+=6;
		y_old=y;
	}
}
*/
void oled_scrollVert(int direction,int amount) {
	//0=down,1=up
	amount&=0x7F;
	unsigned char shifter=amount;
	for(int a=0;a<8;a++) {
		shifter|=shifter>>1;
	}
	unsigned char array[8];
	switch(direction) {
		case 0:
			for(int i=0;i<128;i++) {
				for(int j=i;j<1024;j+=128) {
					array[j/128]=buffer[j];
				}
				unsigned char bits1 = 0, bits2 = 0;
				for(int k=0;k<8;k++) {
	    			bits2 = array[k] & shifter;
	    			array[k] <<= amount;
	    			array[k] |= bits1 >> (8-amount);
	    			bits1 = bits2;
				}
				for(int l=i;l<1024;l+=128) {
					buffer[l]=array[l/128];
				}
			}
			break;
		case 1:
			
			break;
		default:
			return;
			break;
	}
}
void oled_clear() {
	for(int i=0;i<1024;i++) {
		sendCharReg(0x00,DATA_REGISTER);
	}
}
void oled_displayAdafruitLogo() {
	sendDisplayInitCommands();
    for (int i=0; i<1024; i++) {
		sendCharReg(adaLogo[i],DATA_REGISTER);
	}
}
void oled_initOLED(char addr) {

	oled_fd=wiringPiI2CSetup(addr);

	oled_clearBuffer();

	sendCharReg(0xAE,COMMAND_REGISTER);
	sendCharReg(0xD5,COMMAND_REGISTER);
	sendCharReg(0x80,COMMAND_REGISTER);
	sendCharReg(0xA8,COMMAND_REGISTER);
	sendCharReg(0x3F,COMMAND_REGISTER);
	sendCharReg(0xD3,COMMAND_REGISTER);
	sendCharReg(0x00,COMMAND_REGISTER);
	sendCharReg(0x40|0x0,COMMAND_REGISTER);
	sendCharReg(0x8D,COMMAND_REGISTER);
	sendCharReg(0x14,COMMAND_REGISTER);//VCC STATE : 10,14
	sendCharReg(0x20,COMMAND_REGISTER);
	sendCharReg(0x00,COMMAND_REGISTER);
	sendCharReg(0xA0|0x1,COMMAND_REGISTER);
	sendCharReg(0xC8,COMMAND_REGISTER);
	sendCharReg(0xDA,COMMAND_REGISTER);
	sendCharReg(0x12,COMMAND_REGISTER);
	sendCharReg(0x81,COMMAND_REGISTER);
	sendCharReg(0xCF,COMMAND_REGISTER);//VCC STATE : 9F;CF
	sendCharReg(0xD9,COMMAND_REGISTER);
	sendCharReg(0xF1,COMMAND_REGISTER);//VCC STATE : 22;F1
	sendCharReg(0xDB,COMMAND_REGISTER);
	sendCharReg(0x40,COMMAND_REGISTER);
	sendCharReg(0xA4,COMMAND_REGISTER);
	sendCharReg(0xA6,COMMAND_REGISTER);
	sendCharReg(0x2E,COMMAND_REGISTER);
	sendCharReg(0xAF,COMMAND_REGISTER);
	
	delay(20);
	oled_clearBuffer();
	//writeString("A",64,32);
	oled_writeImage("driver/display/oled/intel.png",0,0);
	oled_displayBuffer();
	delay(1000);
	oled_clearBuffer();
	oled_displayBuffer();
}